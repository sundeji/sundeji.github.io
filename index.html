<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸµ éšæœºéŸ³ä¹æ’­æ”¾å™¨</title>
</head>
<body>
  <h2>ğŸ² éšæœºéŸ³ä¹æ’­æ”¾å™¨</h2>
  <button onclick="start()">å¼€å§‹</button>
  <button onclick="playRandomSong()">æ’­æ”¾éšæœºæ­Œæ›²</button>
  <button onclick="pauseMusic()">æš‚åœ</button>
  <button onclick="stop()">åœæ­¢</button>

  <audio id="myAudio"></audio>
  <textarea id="log" rows="10" cols="70"></textarea>

  <script>
    const audio = document.getElementById('myAudio');
    const maxIntervalTime = 2 * 60 * 1000; // æœ€å¤§æ’­æ”¾é—´éš”æ—¶é—´ms
    const minIntervalTime = 1 * 60 * 1000; // æœ€å°æ’­æ”¾é—´éš”æ—¶é—´ms
    const pauseMusicStartTime = "23:30"; // æš‚åœå¼€å§‹æ—¶é—´
    const pauseMusicStopTime = "05:30"; // æš‚åœç»“æŸæ—¶é—´
    var isStarted = "0";  //1:å·²ç»å¼€å§‹ 2:å·²ç»ç»“æŸ

    // æ­Œæ›²åˆ—è¡¨ï¼ˆä½ å¯ä»¥æ”¹æˆä½ è‡ªå·±çš„æ–‡ä»¶ï¼‰
    const songs = [
      "å‰ªæŒ‡ç”²01.mov",
      "å‰ªæŒ‡ç”²02.mov",
      "å‰ªæŒ‡ç”²03.mov",
      "å‰ªæŒ‡ç”²04.mov",
      "å‰ªæŒ‡ç”²05.mov",
      "golpe-en-mesa-con-mano-hit-table-with-hand-171046.mp3",
      "æ•²æ¡Œå­å£°éŸ³.mov",
      "æ•²æ¡Œå­å£°éŸ³.mov",
      "æ•²æ¡Œå­å£°éŸ³.mov",
      "æ•²æ¡Œå­02.mov"
    ];

    //ä¼‘çœ  æ¯«ç§’
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
     // å¼€å§‹
     function start(){
        console.log("å¼€å§‹:[" +new Date().toLocaleString() + "]");
        appendLog("å¼€å§‹:[" +new Date().toLocaleString() + "]")
        // å½“å½“å‰æ­Œæ›²æ’­æ”¾ç»“æŸæ—¶ï¼Œè‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
        audio.addEventListener('ended',playRandomSong);
        // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        setInterval(checkAndRun, 60 * 1000);
        //è¿è¡Œ
        playRandomSong();
        isStarted = "1";
    }
    
    // åœæ­¢
    function stop(){
         console.log("åœæ­¢:[" +new Date() + "]");
         audio.removeEventListener('ended',playRandomSong);
         isStarted = "2";
    } 

    function checkAndRun(){
      if (isInPreciseRange(pauseMusicStartTime, pauseMusicStopTime)){
        if (isStarted === "1"){
          console.log(`audio.pause()æš‚åœï¼š`+new Date());
          stop();
        }
      } else {
        if (isStarted === "2"){
          start();
        }
      }
    }


    //æ˜¯å¦åœ¨æ—¶é—´æ®µå†… ä¾‹ï¼šisInPreciseRange("15:34", "16:33")
    function isInPreciseRange(start, end) {
       const now = new Date();
       const nowMinutes = now.getHours() * 60 + now.getMinutes();
       const [startH, startM] = start.split(':').map(Number);
       const [endH, endM] = end.split(':').map(Number);
       const startMinutes = startH * 60 + startM;
       const endMinutes = endH * 60 + endM;
      return nowMinutes >= startMinutes && nowMinutes < endMinutes;
    }


    async function playRandomSong() {
      // éšæœºæ’­æ”¾é—´éš”æ—¶é—´
      //Math.random() * ( æœ€å¤§å€¤ - æœ€å°å€¤ ) + æœ€å°å€¤;
      let randomSleepTime = Math.floor(Math.random() * (maxIntervalTime - minIntervalTime) + minIntervalTime);
      await sleep(randomSleepTime);
      // éšæœºé€‰ä¸€é¦–
      const randomIndex = Math.floor(Math.random() * songs.length);
      console.log("randomIndex:"+Math.floor(Math.random() * songs.length)+ "[" + new Date().toLocaleString() + "]");
      appendLog("randomIndex:"+Math.floor(Math.random() * songs.length)+ "[" + new Date().toLocaleString() + "]")
      const chosenSong = songs[randomIndex];
      audio.src = chosenSong;

      // åœ¨åŠ è½½å®Œæˆåè®¾ç½®éšæœºæ’­æ”¾æ—¶é—´
      audio.onloadedmetadata = () => {
        const duration = audio.duration;
        const randomTime = Math.random() * duration * 0.5; // éšæœºç§’æ•°
        audio.currentTime = randomTime;
        audio.play();
        console.log(`æ­£åœ¨æ’­æ”¾ï¼š${chosenSong}ï¼Œä» ${randomTime.toFixed(2)} ç§’å¼€å§‹`);
        appendLog(`æ­£åœ¨æ’­æ”¾ï¼š${chosenSong}ï¼Œä» ${randomTime.toFixed(2)} ç§’å¼€å§‹`);
      };
    }

    function playMusic() {
      audio.play();
    }

    function pauseMusic() {
      audio.pause();
    }

    function appendLog(message) {
      const textarea = document.getElementById('log');
      textarea.value += `${message}\n`;
      // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€åº•éƒ¨
      textarea.scrollTop = textarea.scrollHeight;
    }
  </script>
</body>
</html>
